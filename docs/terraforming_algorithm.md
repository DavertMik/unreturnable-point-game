# Алгоритм Тераформінгу з Спавнером

## Огляд

Система тераформінгу створює динамічні параболічні пагорби у світі Hytopia з візуальним спавнером, який показує джерело тераформінгу.

## Основні Компоненти

### 1. Спавнер Тераформінгу

**Призначення**: Візуальний індикатор центру тераформінгу
- **Текстура**: `dragons-stone.png` (унікальна текстура для відрізнення)
- **Розмір**: 1.4x1.4x1.4 блоки (трохи більше стандартного)
- **Позиція**: Центр області тераформінгу + 2 блоки вгору
- **Тип фізики**: FIXED (не рухається, не падає)

```typescript
// Створення спавнера
this.spawnerEntity = new Entity({
  name: 'Terraforming Spawner',
  blockTextureUri: 'blocks/dragons-stone.png',
  blockHalfExtents: { x: 0.7, y: 0.7, z: 0.7 },
  rigidBodyOptions: {
    type: RigidBodyType.FIXED,
  },
});
```

### 2. Алгоритм Параболічного Росту

**Формула Параболи**: `heightMultiplier = max(0, 1 - (normalizedDistance²))`

Де:
- `normalizedDistance` = відстань від центру / максимальний радіус
- `heightMultiplier` визначає висоту в конкретній точці

### 3. Система Хвиль

**Принцип**: Блоки з'являються хвилями, що розходяться від центру

```typescript
const currentWaveRadius = stepsElapsed * elevationSpeed;
if (distanceFromCenter > currentWaveRadius) {
  targetComplete = false;
  continue; // Пропустити блоки поза поточною хвилею
}
```

## Повний Цикл Тераформінгу

### Фаза 1: Ініціалізація
1. **Створення спавнера** в центрі області
2. **Позиціонування** на висоті `currentHeight + 2`
3. **Візуальна індикація** початку процесу

### Фаза 2: Вибір Цілі
1. **Випадковий вибір** позиції в межах області
2. **Перевірка меж** з урахуванням розміру тераформінгу
3. **Реєстрація часу** початку нової цілі

### Фаза 3: Побудова Хвиль
```typescript
for (let x = target.x - halfSize; x < target.x + halfSize; x++) {
  for (let z = target.z - halfSize; z < target.z + halfSize; z++) {
    // 1. Перевірка меж області
    if (!this.isWithinBounds(x, z)) continue;
    
    // 2. Розрахунок відстані від центру цілі
    const distance = sqrt((x - target.x)² + (z - target.z)²);
    
    // 3. Перевірка поточної хвилі
    if (distance > currentWaveRadius) continue;
    
    // 4. Розрахунок цільової висоти (парабола)
    const heightMultiplier = max(0, 1 - (distance/maxRadius)²);
    const targetHeight = floor(target.y * heightMultiplier);
    
    // 5. Поступове додавання блоків
    if (currentHeight < targetHeight) {
      setBlock(x, currentHeight + 1, z, blockTypeId);
    }
  }
}
```

### Фаза 4: Завершення
1. **Перевірка завершення** поточної цілі
2. **Вибір нової цілі** або продовження поточної
3. **Видалення спавнера** при зупинці

## Параметри Конфігурації

### Базові Параметри
```typescript
interface TerraformingOptions {
  centerX: number;           // Центр X (обов'язково)
  centerZ: number;           // Центр Z (обов'язково)
  size: number;              // Розмір області (обов'язково)
  targetHeight?: number;     // Макс. висота (за замовчуванням: 5)
  intervalMs?: number;       // Інтервал кроків (за замовчуванням: 10000)
  terraformSize?: number;    // Розмір пагорба (за замовчуванням: 10)
  blockTypeId?: number;      // ID блоку (за замовчуванням: 2 - глина)
  elevationSpeed?: number;   // Швидкість хвилі (за замовчуванням: 0.5)
  spawnerBlockTypeId?: number; // ID спавнера (за замовчуванням: 3)
}
```

### Рекомендовані Налаштування

#### Для Швидкого Тестування:
```typescript
{
  intervalMs: 2000,      // Швидкі кроки
  elevationSpeed: 2,     // Швидкі хвилі
  terraformSize: 8,      // Менші пагорби
}
```

#### Для Реалістичного Процесу:
```typescript
{
  intervalMs: 8000,      // Повільні кроки
  elevationSpeed: 0.5,   // Повільні хвилі
  terraformSize: 15,     // Великі пагорби
}
```

#### Для Великомасштабного Тераформінгу:
```typescript
{
  size: 100,             // Велика область
  targetHeight: 20,      // Високі пагорби
  intervalMs: 12000,     // Дуже повільні кроки
}
```

## Стани Системи

### 1. Неактивна
- Спавнер: відсутній
- Цілі: немає
- Процес: зупинений

### 2. Активна
- Спавнер: створений і видимий
- Цілі: активна ціль або вибір нової
- Процес: виконуються кроки тераформінгу

### 3. У Процесі Хвилі
- Спавнер: активний
- Поточна хвиля: розширюється від центру цілі
- Блоки: додаються послідовно

## API Методи для Спавнера

### Основні Методи
```typescript
// Перевірка наявності спавнера
terraforming.hasActiveSpawner(): boolean

// Отримання сутності спавнера
terraforming.getSpawner(): Entity | null

// Повний статус включно зі спавнером
terraforming.getStatus(): {
  isActive: boolean;
  hasSpawner: boolean;
  spawnerPosition: { x, y, z } | null;
  // ... інші поля
}
```

### Приклад Моніторингу
```typescript
// Логування стану спавнера
setInterval(() => {
  const status = terraforming.getStatus();
  
  if (status.hasSpawner) {
    console.log(`Спавнер активний на позиції: ${JSON.stringify(status.spawnerPosition)}`);
  } else {
    console.log('Спавнер неактивний');
  }
}, 5000);
```

## Візуальні Ефекти

### Спавнер
- **Унікальна текстура**: `dragons-stone.png` відрізняється від блоків тераформінгу
- **Збільшений розмір**: 1.4x стандартного для помітності
- **Стаціонарне положення**: не рухається і не падає

### Тераформінг
- **Параболічна форма**: природний вигляд пагорбів
- **Хвильове розширення**: реалістична анімація росту
- **Різні текстури**: підтримка різних типів блоків

## Оптимізація

### Продуктивність
- **Обмежена область**: тільки в межах заданого розміру
- **Пакетна обробка**: максимум один крок за інтервал
- **Перевірка меж**: ранній вихід для блоків поза областю

### Память
- **Автоматичне очищення**: спавнер видаляється при зупинці
- **Мінімальні дані**: тільки необхідна інформація про стан

Ця система забезпечує візуально привабливий та функціональний процес тераформінгу з чітким джерелом (спавнером) для кращого користувацького досвіду. 